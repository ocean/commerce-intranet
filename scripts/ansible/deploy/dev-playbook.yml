---
- hosts: localhost

  # To be run as "admin", so no need for escalation
  # become: true
  # become_method: sudo

  # Most should be set already
  # environment:
    # - http_proxy: blah

  vars:
    theme_build_directory: "web/themes/custom/intranet"
    drupal_app_root_directory: "/opt/app/html/intranet"

  # Not needed yet
  # roles:
    # - { role: common, tags: ["common"] }

  # Ok, we are going to deploy this thing
  tasks:
    - debug: var=git_new_revision
    - name: Register drupal_repo_directory variable
      shell: pwd
      register: drupal_repo_directory
    - debug: var=drupal_repo_directory
    - name: Count how many files have changed
      shell: |
        `which git` diff $oldrev $newrev --diff-filter=ACDMR --name-only | wc -l
      register: git_number_of_files_changed
    - debug:
        msg: "Files changed: {{ git_number_of_files_changed.stdout }}"
    - name: Check if theme code needs rebuilding
      shell: |
        `which git` diff $oldrev $newrev --name-only | grep 'web\/themes\/custom' | wc -l
      register: git_number_of_theme_files_changed
    - name: Check if Drupal code has changed and update needs running
      shell: |
        `which git` diff $oldrev $newrev --name-only | grep -E -v 'web\/themes\/custom|tests|scripts' | wc -l
      register: git_number_of_code_files_changed
    # - name: Check current directory
    #   command: pwd
    #   register: directory_listing
    # - debug: var=directory_listing
    # - name: Run hi there
    #   command: echo "hi there"
    #   when: directory_listing.stdout.find('composer') != -1

  handlers:
    # - name: restart mysqld
    #   service: name=mysqld state=restarted
    # - name: restart httpd
    #   service: name=httpd state=restarted
